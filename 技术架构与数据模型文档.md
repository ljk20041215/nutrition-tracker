# 个人每日营养记录软件 - 技术架构与数据模型文档

## 1. 技术栈确认与补充

### 1.1 现有技术栈
- **语言**: Go 1.25.5
- **Web框架**: Gin 1.11.0

### 1.2 需要补充的技术栈 (MVP简化版)
- **数据库**: SQLite3 (便于快速开发和部署)
- **ORM**: GORM v1.25.0+ (简化数据库操作)
- **认证**: JWT (github.com/golang-jwt/jwt/v5)
- **配置管理**: Viper (github.com/spf13/viper)
- **日志**: Zap (go.uber.org/zap)
- **密码加密**: bcrypt (golang.org/x/crypto/bcrypt)
- **UUID生成**: github.com/google/uuid

### 1.3 Golang特色功能应用计划
- **Goroutine**: 并发处理请求、异步任务执行
- **Channel**: 任务调度、并发控制、数据传递
- **WaitGroup**: 同步并发任务
- **Context**: 请求上下文管理、超时控制
- **Select**: 多路复用I/O操作

## 2. 项目架构设计

### 2.1 项目结构
```
nutrition-tracker/
├── cmd/                    # 应用入口
│   └── server/             # 服务器入口
│       └── main.go         # 主程序入口
├── configs/                # 配置文件
│   ├── config.example.yaml # 示例配置文件
│   └── config.yaml         # 实际配置文件(忽略git)
├── internal/               # 内部包
│   ├── auth/               # 认证相关
│   │   ├── middleware.go   # 认证中间件
│   │   └── service.go      # 认证服务
│   ├── handler/            # HTTP处理器
│   │   ├── auth.go         # 认证相关处理器
│   │   ├── food.go         # 食物相关处理器
│   │   ├── goal.go         # 目标相关处理器
│   │   ├── record.go       # 记录相关处理器
│   │   └── user.go         # 用户相关处理器
│   ├── model/              # 数据模型
│   │   ├── food.go         # 食物模型
│   │   ├── goal.go         # 目标模型
│   │   ├── record.go       # 记录模型
│   │   └── user.go         # 用户模型
│   ├── repository/         # 数据访问层
│   │   ├── food_repo.go    # 食物数据访问
│   │   ├── goal_repo.go    # 目标数据访问
│   │   ├── record_repo.go  # 记录数据访问
│   │   └── user_repo.go    # 用户数据访问
│   └── service/            # 业务逻辑层
│       ├── food_service.go # 食物服务
│       ├── goal_service.go # 目标服务
│       ├── record_service.go # 记录服务
│       └── user_service.go # 用户服务
├── pkg/                    # 公共包
│   ├── cache/              # 缓存工具
│   ├── database/           # 数据库连接
│   ├── logger/             # 日志工具
│   └── validator/          # 数据验证
├── go.mod                  # Go模块定义
├── go.sum                  # 依赖校验和
└── README.md               # 项目说明
```

### 2.2 分层架构说明
1. **Handler层**: 处理HTTP请求，参数验证，响应格式化
2. **Service层**: 实现核心业务逻辑
3. **Repository层**: 数据访问，与数据库交互
4. **Model层**: 数据结构定义
5. **Middleware层**: 认证、日志、错误处理等中间件

## 3. 数据模型定义

### 3.1 用户模型 (internal/model/user.go)
```go
package model

import (
	"time"

	"github.com/google/uuid"
	"gorm.io/gorm"
)

// User 用户模型
type User struct {
	ID            uuid.UUID `gorm:"type:uuid;primary_key" json:"id"`
	Email         string    `gorm:"type:varchar(255);uniqueIndex" json:"email"`
	Phone         string    `gorm:"type:varchar(20);uniqueIndex" json:"phone"`
	PasswordHash  string    `gorm:"type:varchar(255)" json:"-"`
	Nickname      string    `gorm:"type:varchar(50)" json:"nickname"`
	Gender        int       `gorm:"type:int;default:0" json:"gender"` // 0:未知,1:男,2:女
	Age           int       `gorm:"type:int" json:"age"`
	Height        float64   `gorm:"type:float" json:"height"` // cm
	Weight        float64   `gorm:"type:float" json:"weight"` // kg
	ActivityLevel int       `gorm:"type:int;default:3" json:"activity_level"` // 1-5
	CreatedAt     time.Time `gorm:"autoCreateTime" json:"created_at"`
	UpdatedAt     time.Time `gorm:"autoUpdateTime" json:"updated_at"`
	DeletedAt     gorm.DeletedAt `gorm:"index" json:"-"`
}

// BeforeCreate 创建前钩子，生成UUID
func (u *User) BeforeCreate(tx *gorm.DB) error {
	u.ID = uuid.New()
	return nil
}
```

### 3.2 营养目标模型 (internal/model/goal.go)
```go
package model

import (
	"time"

	"github.com/google/uuid"
	"gorm.io/gorm"
)

// NutritionGoal 营养目标模型
type NutritionGoal struct {
	ID             uuid.UUID `gorm:"type:uuid;primary_key" json:"id"`
	UserID         uuid.UUID `gorm:"type:uuid;index" json:"user_id"`
	Calories       float64   `gorm:"type:float" json:"calories"`       // 热量目标(千卡)
	Protein        float64   `gorm:"type:float" json:"protein"`        // 蛋白质目标(克)
	Carbohydrates  float64   `gorm:"type:float" json:"carbohydrates"`  // 碳水化合物目标(克)
	Fat            float64   `gorm:"type:float" json:"fat"`            // 脂肪目标(克)
	Fiber          float64   `gorm:"type:float" json:"fiber"`          // 膳食纤维目标(克)
	Water          float64   `gorm:"type:float" json:"water"`          // 水分目标(毫升)
	VitaminA       float64   `gorm:"type:float" json:"vitamin_a"`      // 维生素A目标(微克)
	VitaminC       float64   `gorm:"type:float" json:"vitamin_c"`      // 维生素C目标(毫克)
	VitaminD       float64   `gorm:"type:float" json:"vitamin_d"`      // 维生素D目标(微克)
	Calcium        float64   `gorm:"type:float" json:"calcium"`        // 钙目标(毫克)
	Iron           float64   `gorm:"type:float" json:"iron"`           // 铁目标(毫克)
	CreatedAt      time.Time `gorm:"autoCreateTime" json:"created_at"`
	UpdatedAt      time.Time `gorm:"autoUpdateTime" json:"updated_at"`
	DeletedAt      gorm.DeletedAt `gorm:"index" json:"-"`
	
	// 关联
	User User `gorm:"foreignKey:UserID" json:"-"`
}

// BeforeCreate 创建前钩子，生成UUID
func (g *NutritionGoal) BeforeCreate(tx *gorm.DB) error {
	g.ID = uuid.New()
	return nil
}
```

### 3.3 食物模型 (internal/model/food.go)
```go
package model

import (
	"time"

	"github.com/google/uuid"
	"gorm.io/gorm"
)

// FoodCategory 食物类别枚举
type FoodCategory int

const (
	FoodCategoryGrain     FoodCategory = 1 // 谷物
	FoodCategoryMeat      FoodCategory = 2 // 肉类
	FoodCategoryVegetable FoodCategory = 3 // 蔬菜
	FoodCategoryFruit     FoodCategory = 4 // 水果
	FoodCategoryDairy     FoodCategory = 5 // 乳制品
	FoodCategoryOil       FoodCategory = 6 // 油脂
	FoodCategoryNut       FoodCategory = 7 // 坚果
	FoodCategoryBeverage  FoodCategory = 8 // 饮料
	FoodCategoryOther     FoodCategory = 9 // 其他
)

// Food 食物库模型
type Food struct {
	ID            uuid.UUID     `gorm:"type:uuid;primary_key" json:"id"`
	Name          string        `gorm:"type:varchar(100);index" json:"name"`
	Category      FoodCategory  `gorm:"type:int" json:"category"`
	BaseQuantity  float64       `gorm:"type:float;default:100" json:"base_quantity"` // 基础份量
	BaseUnit      string        `gorm:"type:varchar(20);default:'克'" json:"base_unit"` // 基础单位
	Calories      float64       `gorm:"type:float" json:"calories"`      // 热量/100克(千卡)
	Protein       float64       `gorm:"type:float" json:"protein"`       // 蛋白质/100克(克)
	Carbohydrates float64       `gorm:"type:float" json:"carbohydrates"` // 碳水化合物/100克(克)
	Fat           float64       `gorm:"type:float" json:"fat"`           // 脂肪/100克(克)
	Fiber         float64       `gorm:"type:float" json:"fiber"`         // 膳食纤维/100克(克)
	SaturatedFat  float64       `gorm:"type:float" json:"saturated_fat"`  // 饱和脂肪/100克(克)
	TransFat      float64       `gorm:"type:float" json:"trans_fat"`      // 反式脂肪/100克(克)
	Cholesterol   float64       `gorm:"type:float" json:"cholesterol"`   // 胆固醇/100克(毫克)
	Sodium        float64       `gorm:"type:float" json:"sodium"`        // 钠/100克(毫克)
	Sugar         float64       `gorm:"type:float" json:"sugar"`         // 糖分/100克(克)
	CreatedAt     time.Time     `gorm:"autoCreateTime" json:"created_at"`
	UpdatedAt     time.Time     `gorm:"autoUpdateTime" json:"updated_at"`
	DeletedAt     gorm.DeletedAt `gorm:"index" json:"-"`
}

// CustomFood 自定义食物模型
type CustomFood struct {
	ID            uuid.UUID `gorm:"type:uuid;primary_key" json:"id"`
	UserID        uuid.UUID `gorm:"type:uuid;index" json:"user_id"`
	Name          string    `gorm:"type:varchar(100);index" json:"name"`
	BaseQuantity  float64   `gorm:"type:float;default:100" json:"base_quantity"` // 基础份量
	BaseUnit      string    `gorm:"type:varchar(20);default:'克'" json:"base_unit"` // 基础单位
	Calories      float64   `gorm:"type:float" json:"calories"`      // 热量/基础份量(千卡)
	Protein       float64   `gorm:"type:float" json:"protein"`       // 蛋白质/基础份量(克)
	Carbohydrates float64   `gorm:"type:float" json:"carbohydrates"` // 碳水化合物/基础份量(克)
	Fat           float64   `gorm:"type:float" json:"fat"`           // 脂肪/基础份量(克)
	CreatedAt     time.Time `gorm:"autoCreateTime" json:"created_at"`
	UpdatedAt     time.Time `gorm:"autoUpdateTime" json:"updated_at"`
	DeletedAt     gorm.DeletedAt `gorm:"index" json:"-"`
	
	// 关联
	User User `gorm:"foreignKey:UserID" json:"-"`
}

// BeforeCreate 创建前钩子，生成UUID
func (f *Food) BeforeCreate(tx *gorm.DB) error {
	f.ID = uuid.New()
	return nil
}

// BeforeCreate 创建前钩子，生成UUID
func (cf *CustomFood) BeforeCreate(tx *gorm.DB) error {
	cf.ID = uuid.New()
	return nil
}
```

### 3.4 营养记录模型 (internal/model/record.go)
```go
package model

import (
	"time"

	"github.com/google/uuid"
	"gorm.io/gorm"
)

// MealType 餐次类型枚举
type MealType int

const (
	MealTypeBreakfast MealType = 1 // 早餐
	MealTypeLunch     MealType = 2 // 午餐
	MealTypeDinner    MealType = 3 // 晚餐
	MealTypeSnack     MealType = 4 // 加餐
)

// MealRecord 餐次记录模型
type MealRecord struct {
	ID         uuid.UUID `gorm:"type:uuid;primary_key" json:"id"`
	UserID     uuid.UUID `gorm:"type:uuid;index" json:"user_id"`
	MealType   MealType  `gorm:"type:int" json:"meal_type"`
	RecordDate time.Time `gorm:"type:date;index" json:"record_date"`
	RecordTime time.Time `gorm:"type:time" json:"record_time"`
	CreatedAt  time.Time `gorm:"autoCreateTime" json:"created_at"`
	UpdatedAt  time.Time `gorm:"autoUpdateTime" json:"updated_at"`
	DeletedAt  gorm.DeletedAt `gorm:"index" json:"-"`
	
	// 关联
	User      User         `gorm:"foreignKey:UserID" json:"-"`
	Foods     []FoodRecord `gorm:"foreignKey:MealRecordID" json:"foods"`
}

// FoodRecord 食物记录模型
type FoodRecord struct {
	ID            uuid.UUID `gorm:"type:uuid;primary_key" json:"id"`
	MealRecordID  uuid.UUID `gorm:"type:uuid;index" json:"meal_record_id"`
	FoodID        *uuid.UUID `gorm:"type:uuid;index" json:"food_id"`        // 关联食物库
	CustomFoodID  *uuid.UUID `gorm:"type:uuid;index" json:"custom_food_id"` // 关联自定义食物
	Quantity      float64   `gorm:"type:float" json:"quantity"`      // 份量
	Unit          string    `gorm:"type:varchar(20)" json:"unit"`    // 单位
	Calories      float64   `gorm:"type:float" json:"calories"`      // 热量(千卡)
	Protein       float64   `gorm:"type:float" json:"protein"`       // 蛋白质(克)
	Carbohydrates float64   `gorm:"type:float" json:"carbohydrates"` // 碳水化合物(克)
	Fat           float64   `gorm:"type:float" json:"fat"`           // 脂肪(克)
	Fiber         float64   `gorm:"type:float" json:"fiber"`         // 膳食纤维(克)
	SaturatedFat  float64   `gorm:"type:float" json:"saturated_fat"`  // 饱和脂肪(克)
	TransFat      float64   `gorm:"type:float" json:"trans_fat"`      // 反式脂肪(克)
	Cholesterol   float64   `gorm:"type:float" json:"cholesterol"`   // 胆固醇(毫克)
	Sodium        float64   `gorm:"type:float" json:"sodium"`        // 钠(毫克)
	Sugar         float64   `gorm:"type:float" json:"sugar"`         // 糖分(克)
	CreatedAt     time.Time `gorm:"autoCreateTime" json:"created_at"`
	UpdatedAt     time.Time `gorm:"autoUpdateTime" json:"updated_at"`
	DeletedAt     gorm.DeletedAt `gorm:"index" json:"-"`
	
	// 关联
	MealRecord MealRecord `gorm:"foreignKey:MealRecordID" json:"-"`
	Food       *Food      `gorm:"foreignKey:FoodID" json:"-"`
	CustomFood *CustomFood `gorm:"foreignKey:CustomFoodID" json:"-"`
}

// BeforeCreate 创建前钩子，生成UUID
func (mr *MealRecord) BeforeCreate(tx *gorm.DB) error {
	mr.ID = uuid.New()
	return nil
}

// BeforeCreate 创建前钩子，生成UUID
func (fr *FoodRecord) BeforeCreate(tx *gorm.DB) error {
	fr.ID = uuid.New()
	return nil
}
```

## 4. 数据库设计 (MVP简化版)

### 4.1 数据库连接配置
使用SQLite3作为MVP阶段的数据库，简化配置和部署：

```yaml
# configs/config.yaml
database:
  driver: sqlite3
  path: ./nutrition_tracker.db
  timezone: Asia/Shanghai

server:
  port: 8080
  mode: debug
  jwt_secret: your_secret_key_here
  jwt_expiration: 24h
```

### 4.2 数据库迁移
使用GORM的自动迁移功能，在应用启动时自动创建表结构：

```go
// pkg/database/database.go
func Migrate(db *gorm.DB) error {
	return db.AutoMigrate(
		&model.User{},
		&model.NutritionGoal{},
		&model.Food{},
		&model.CustomFood{},
		&model.MealRecord{},
		&model.FoodRecord{},
	)
}
```

### 4.3 数据库初始化 (预加载食物数据)
```go
// pkg/database/init.go
func InitFoodData(db *gorm.DB) error {
	// 检查是否已有数据
	var count int64
	db.Model(&model.Food{}).Count(&count)
	if count > 0 {
		return nil
	}

	// 预加载基础食物数据
	foods := []model.Food{
		{Name: "米饭", Category: model.FoodCategoryGrain, Calories: 116, Protein: 2.6, Carbohydrates: 25.9, Fat: 0.3},
		{Name: "鸡蛋", Category: model.FoodCategoryMeat, Calories: 143, Protein: 12.6, Carbohydrates: 1.1, Fat: 9.5},
		{Name: "牛奶", Category: model.FoodCategoryDairy, Calories: 42, Protein: 3.2, Carbohydrates: 4.8, Fat: 1.0},
		{Name: "苹果", Category: model.FoodCategoryFruit, Calories: 52, Protein: 0.3, Carbohydrates: 13.8, Fat: 0.2},
		{Name: "西兰花", Category: model.FoodCategoryVegetable, Calories: 34, Protein: 2.8, Carbohydrates: 6.6, Fat: 0.4},
	}

	// 使用Goroutine和Channel并发导入数据
	errCh := make(chan error)
	var wg sync.WaitGroup
	
	// 每批处理5个食物
	batchSize := 5
	for i := 0; i < len(foods); i += batchSize {
		end := i + batchSize
		if end > len(foods) {
			end = len(foods)
		}
		
		wg.Add(1)
		go func(batch []model.Food) {
			defer wg.Done()
			if err := db.Create(&batch).Error; err != nil {
				errCh <- err
				return
			}
			errCh <- nil
		}(foods[i:end])
	}
	
	// 等待所有任务完成
	go func() {
		wg.Wait()
		close(errCh)
	}()
	
	// 收集错误
	for err := range errCh {
		if err != nil {
			return err
		}
	}
	
	return nil
}
```

## 5. API接口设计

### 5.1 认证相关接口
| 方法 | 路径 | 功能 | 认证 |
|------|------|------|------|
| POST | /api/v1/auth/register | 用户注册 | 否 |
| POST | /api/v1/auth/login | 用户登录 | 否 |
| POST | /api/v1/auth/logout | 用户登出 | 是 |
| POST | /api/v1/auth/reset-password | 密码重置 | 否 |
| POST | /api/v1/auth/verify-email | 邮箱验证 | 否 |

### 5.2 用户相关接口
| 方法 | 路径 | 功能 | 认证 |
|------|------|------|------|
| GET | /api/v1/users/profile | 获取用户信息 | 是 |
| PUT | /api/v1/users/profile | 更新用户信息 | 是 |
| PUT | /api/v1/users/password | 修改密码 | 是 |

### 5.3 营养目标相关接口
| 方法 | 路径 | 功能 | 认证 |
|------|------|------|------|
| GET | /api/v1/goals | 获取营养目标 | 是 |
| POST | /api/v1/goals | 设置营养目标 | 是 |
| PUT | /api/v1/goals | 更新营养目标 | 是 |

### 5.4 营养记录相关接口
| 方法 | 路径 | 功能 | 认证 |
|------|------|------|------|
| GET | /api/v1/records/:date | 获取指定日期记录 | 是 |
| GET | /api/v1/records/history | 获取历史记录 | 是 |
| POST | /api/v1/records/meal | 创建餐次记录 | 是 |
| POST | /api/v1/records/food | 添加食物记录 | 是 |
| PUT | /api/v1/records/food/:id | 更新食物记录 | 是 |
| DELETE | /api/v1/records/food/:id | 删除食物记录 | 是 |

### 5.5 食物相关接口
| 方法 | 路径 | 功能 | 认证 |
|------|------|------|------|
| GET | /api/v1/foods | 搜索食物 | 是 |
| GET | /api/v1/foods/:id | 获取食物详情 | 是 |
| POST | /api/v1/custom-foods | 创建自定义食物 | 是 |
| GET | /api/v1/custom-foods | 获取自定义食物列表 | 是 |
| PUT | /api/v1/custom-foods/:id | 更新自定义食物 | 是 |
| DELETE | /api/v1/custom-foods/:id | 删除自定义食物 | 是 |

## 6. 技术实现要点 (强化Golang特色功能)

### 6.1 Goroutine与Channel的应用

#### 6.1.1 异步食物记录处理
```go
// internal/service/record_service.go
func (s *RecordService) CreateFoodRecord(ctx context.Context, record *model.FoodRecord) error {
	// 创建带缓冲channel
	ch := make(chan error, 1)
	
	go func() {
		// 异步处理食物记录创建
		err := s.repo.CreateFoodRecord(ctx, record)
		if err != nil {
			zap.L().Error("创建食物记录失败", zap.Error(err))
		}
		ch <- err
	}()
	
	// 设置超时控制
	select {
	case err := <-ch:
		return err
	case <-time.After(5 * time.Second):
		return errors.New("创建记录超时")
	}
}
```

#### 6.1.2 批量营养数据分析
```go
// internal/service/record_service.go
func (s *RecordService) GetDailyNutritionSummary(ctx context.Context, userID uuid.UUID, date time.Time) (*DailySummary, error) {
	// 获取当日所有餐次记录
	mealRecords, err := s.repo.GetMealRecordsByDate(ctx, userID, date)
	if err != nil {
		return nil, err
	}
	
	// 并发处理每个餐次的营养计算
	results := make(chan *MealNutrition, len(mealRecords))
	errors := make(chan error, len(mealRecords))
	var wg sync.WaitGroup
	
	for _, meal := range mealRecords {
		wg.Add(1)
		go func(meal model.MealRecord) {
			defer wg.Done()
			
			// 获取餐次中的所有食物记录
			foodRecords, err := s.repo.GetFoodRecordsByMealID(ctx, meal.ID)
			if err != nil {
				errors <- err
				return
			}
			
			// 计算该餐次的营养总和
			summary := &MealNutrition{
				MealType: meal.MealType,
				Calories: 0,
				Protein:  0,
				Carbohydrates: 0,
				Fat:     0,
			}
			
			for _, food := range foodRecords {
				summary.Calories += food.Calories
				summary.Protein += food.Protein
				summary.Carbohydrates += food.Carbohydrates
				summary.Fat += food.Fat
			}
			
			results <- summary
		}(meal)
	}
	
	// 等待所有goroutine完成
	go func() {
		wg.Wait()
		close(results)
		close(errors)
	}()
	
	// 收集错误
	for err := range errors {
		if err != nil {
			return nil, err
		}
	}
	
	// 汇总所有餐次的营养数据
	dailySummary := &DailySummary{
		Date: date,
		TotalCalories: 0,
		TotalProtein: 0,
		TotalCarbohydrates: 0,
		TotalFat: 0,
		Meals: make([]*MealNutrition, 0),
	}
	
	for result := range results {
		dailySummary.TotalCalories += result.Calories
		dailySummary.TotalProtein += result.Protein
		dailySummary.TotalCarbohydrates += result.Carbohydrates
		dailySummary.TotalFat += result.Fat
		dailySummary.Meals = append(dailySummary.Meals, result)
	}
	
	return dailySummary, nil
}
```

#### 6.1.3 请求限流中间件
```go
// internal/middleware/rate_limit.go
func RateLimiter() gin.HandlerFunc {
	// 使用token bucket算法实现限流
	tokens := make(chan struct{}, 100) // 桶容量100
	
	// 启动goroutine定期填充token
	go func() {
		for {
			select {
			case tokens <- struct{}{}:
				// 成功放入token
			default:
				// 桶已满
			}
			time.Sleep(100 * time.Millisecond) // 每100ms放入一个token
		}
	}()
	
	return func(c *gin.Context) {
		select {
		case <-tokens:
			// 获取到token，继续处理请求
			c.Next()
		default:
			// 没有token，返回限流错误
			c.JSON(http.StatusTooManyRequests, gin.H{"error": "请求过于频繁，请稍后再试"})
			c.Abort()
		}
	}
}
```
```

### 6.2 内存缓存实现 (基于sync.Map)
```go
// internal/cache/memory_cache.go
package cache

import (
	"sync"
	"time"
)

// Item 缓存项
 type Item struct {
	Value      interface{}
	Expiration int64
}

// MemoryCache 内存缓存
 type MemoryCache struct {
	items sync.Map
}

// NewMemoryCache 创建新的内存缓存
func NewMemoryCache() *MemoryCache {
	// 启动定时清理过期数据的goroutine
	cache := &MemoryCache{}
	go cache.cleanupLoop()
	return cache
}

// Set 设置缓存
func (c *MemoryCache) Set(key string, value interface{}, duration time.Duration) {
	expiration := time.Now().Add(duration).UnixNano()
	c.items.Store(key, Item{Value: value, Expiration: expiration})
}

// Get 获取缓存
func (c *MemoryCache) Get(key string) (interface{}, bool) {
	item, ok := c.items.Load(key)
	if !ok {
		return nil, false
	}
	
	cacheItem := item.(Item)
	if cacheItem.Expiration < time.Now().UnixNano() {
		// 数据已过期，删除
		c.items.Delete(key)
		return nil, false
	}
	
	return cacheItem.Value, true
}

// cleanupLoop 定时清理过期数据
func (c *MemoryCache) cleanupLoop() {
	for {
		// 每5分钟清理一次
		time.Sleep(5 * time.Minute)
		
		now := time.Now().UnixNano()
		c.items.Range(func(key, value interface{}) bool {
			item := value.(Item)
			if item.Expiration < now {
				c.items.Delete(key)
			}
			return true
		})
	}
}
```

```go
// internal/repository/food_repo.go
func (r *FoodRepo) GetFoodByID(ctx context.Context, id uuid.UUID) (*model.Food, error) {
	// 尝试从内存缓存获取
	cacheKey := fmt.Sprintf("food:%s", id.String())
	if item, found := r.cache.Get(cacheKey); found {
		return item.(*model.Food), nil
	}
	
	// 缓存未命中，从数据库获取
	var food model.Food
	if err := r.db.Where("id = ?", id).First(&food).Error; err != nil {
		return nil, err
	}
	
	// 存入缓存，有效期1小时
	r.cache.Set(cacheKey, &food, time.Hour)
	return &food, nil
}
```

### 6.3 并发安全的餐次创建
```go
// internal/service/record_service.go
func (s *RecordService) CreateMealRecordWithFoods(ctx context.Context, meal *model.MealRecord, foods []*model.FoodRecord) error {
	// 使用Context实现超时控制
	ctx, cancel := context.WithTimeout(ctx, 10*time.Second)
	defer cancel()
	
	// 事务处理确保数据一致性
	return s.repo.WithTransaction(ctx, func(tx *gorm.DB) error {
		// 创建餐次记录
		if err := s.repo.CreateMealRecord(tx, meal); err != nil {
			return err
		}
		
		// 并发处理食物记录创建
		var wg sync.WaitGroup
		taskErrors := make(chan error, len(foods))
		
		for _, food := range foods {
			food.MealRecordID = meal.ID
			wg.Add(1)
			
			go func(foodRecord *model.FoodRecord) {
				defer wg.Done()
				
				// 计算营养成分
				if err := s.calculateNutrition(foodRecord); err != nil {
					taskErrors <- err
					return
				}
				
				// 创建食物记录
				if err := s.repo.CreateFoodRecord(tx, foodRecord); err != nil {
					taskErrors <- err
					return
				}
				taskErrors <- nil
			}(food)
		}
		
		// 等待所有食物记录处理完成
		go func() {
			wg.Wait()
			close(taskErrors)
		}()
		
		// 收集错误
		for err := range taskErrors {
			if err != nil {
				return err
			}
		}
		
		return nil
	})
}

// calculateNutrition 计算食物的营养成分
func (s *RecordService) calculateNutrition(record *model.FoodRecord) error {
	// 根据食物ID获取食物基础数据
	var food model.Food
	if err := s.repo.GetFoodByID(context.Background(), *record.FoodID); err != nil {
		return err
	}
	
	// 根据食用量计算实际营养成分
	record.Calories = food.Calories * (record.Quantity / food.BaseQuantity)
	record.Protein = food.Protein * (record.Quantity / food.BaseQuantity)
	record.Carbohydrates = food.Carbohydrates * (record.Quantity / food.BaseQuantity)
	record.Fat = food.Fat * (record.Quantity / food.BaseQuantity)
	
	return nil
}
```

## 7. 安全设计与监控

### 7.1 认证与授权
- 使用JWT进行身份认证
- 密码使用bcrypt加密存储

### 7.2 输入验证
- 使用validator/v10进行请求参数验证
- 实现自定义验证规则

### 7.3 防止攻击
- 实现基于channel的请求频率限制
- 防止SQL注入、XSS攻击

### 7.4 日志与监控
```go
// internal/middleware/logger.go
func Logger() gin.HandlerFunc {
	return func(c *gin.Context) {
		// 请求开始时间
		start := time.Now()
		
		// 处理请求
		c.Next()
		
		// 请求结束时间
		end := time.Now()
		duration := end.Sub(start)
		
		// 异步记录日志
		go func() {
			zap.L().Info("请求日志",
				zap.String("method", c.Request.Method),
				zap.String("path", c.Request.URL.Path),
				zap.Int("status", c.Writer.Status()),
				zap.Duration("duration", duration),
				zap.String("client_ip", c.ClientIP()),
			)
		}()
	}
}
```

## 8. 应用启动流程
```go
// cmd/server/main.go
func main() {
	// 初始化配置
	if err := config.Init(); err != nil {
		log.Fatalf("配置初始化失败: %v", err)
	}
	
	// 初始化日志
	logger.Init()
	defer zap.L().Sync()
	
	// 初始化数据库
	db, err := database.Init()
	if err != nil {
		zap.L().Fatal("数据库初始化失败", zap.Error(err))
	}
	
	// 数据库迁移
	if err := database.Migrate(db); err != nil {
		zap.L().Fatal("数据库迁移失败", zap.Error(err))
	}
	
	// 初始化食物数据
	go func() {
		if err := database.InitFoodData(db); err != nil {
			zap.L().Error("初始化食物数据失败", zap.Error(err))
		}
	}()
	
	// 创建Gin引擎
	r := gin.Default()
	
	// 注册中间件
	r.Use(middleware.Logger())
	r.Use(middleware.RateLimiter())
	
	// 注册路由
	router.SetupRoutes(r)
	
	// 启动服务器
	port := config.Get("server.port").String()
	zap.L().Info("服务器启动", zap.String("port", port))
	if err := r.Run(":" + port); err != nil {
		zap.L().Fatal("服务器启动失败", zap.Error(err))
	}
}