# 个人每日营养记录软件 - 功能需求与API接口文档

## 技术栈说明 (MVP版本)
- **语言**: Go 1.25.5 (充分利用Goroutine和Channel实现并发处理)
- **Web框架**: Gin 1.11.0
- **数据库**: PostgreSQL
- **ORM**: GORM v1.25.0+
- **认证**: JWT (github.com/golang-jwt/jwt/v5)
- **日志**: Zap (go.uber.org/zap)
- **缓存**: 基于sync.Map的内存缓存 (并发安全)

## Golang特色功能应用
- **Goroutine**: 用于异步处理请求、并发计算营养数据
- **Channel**: 实现任务调度、并发控制和数据传递
- **WaitGroup**: 同步并发任务，确保所有goroutine完成
- **Context**: 实现请求超时控制和资源管理
- **Select**: 用于多路复用I/O操作和超时控制

## 1. 功能需求详细说明

### 1.1 用户管理模块

#### 1.1.1 用户注册功能
- **功能描述**: 允许用户通过邮箱或手机号注册账号
- **输入信息**:
  - 邮箱/手机号（二选一，必须唯一）
  - 密码（至少6位，包含字母和数字）
  - 确认密码
  - 昵称（可选）
- **业务逻辑**:
  - 验证输入信息的合法性
  - 检查邮箱/手机号是否已被注册
  - 对密码进行bcrypt加密
  - 创建用户记录
  - 生成验证邮件/短信（可选）
  - 返回注册成功信息

#### 1.1.2 用户登录功能
- **功能描述**: 允许用户使用邮箱/手机号和密码登录
- **输入信息**:
  - 邮箱/手机号
  - 密码
- **业务逻辑**:
  - 验证输入信息
  - 根据邮箱/手机号查找用户
  - 验证密码是否正确
  - 生成JWT令牌（有效期24小时）
  - 返回令牌和用户信息

#### 1.1.3 用户信息管理功能
- **功能描述**: 允许用户查看和修改个人信息
- **可修改信息**:
  - 昵称
  - 性别
  - 年龄
  - 身高
  - 体重
  - 活动水平
- **业务逻辑**:
  - 验证用户身份
  - 验证输入信息的合法性
  - 更新用户记录
  - 返回更新后的用户信息

#### 1.1.4 密码重置功能
- **功能描述**: 允许用户通过邮箱/手机号重置密码
- **输入信息**:
  - 注册时使用的邮箱/手机号
- **业务逻辑**:
  - 验证邮箱/手机号是否存在
  - 生成密码重置令牌
  - 发送重置邮件/短信
  - 用户点击链接/输入验证码重置密码

### 1.2 营养目标设置模块

#### 1.2.1 自动计算营养目标功能
- **功能描述**: 根据用户信息自动计算每日营养目标
- **计算依据**:
  - 性别、年龄、身高、体重
  - 活动水平（1-5级）
  - 目标类型（维持体重、减重、增重）
- **计算方法**:
  - 基础代谢率(BMR)计算：
    - 男性: BMR = 88.362 + (13.397 × 体重kg) + (4.799 × 身高cm) - (5.677 × 年龄)
    - 女性: BMR = 447.593 + (9.247 × 体重kg) + (3.098 × 身高cm) - (4.330 × 年龄)
  - 每日总热量(TDEE) = BMR × 活动系数
    - 活动系数：1.2(久坐)、1.375(轻度活动)、1.55(中度活动)、1.725(重度活动)、1.9(极重度活动)
  - 宏量营养素比例：
    - 蛋白质: 体重kg × 1.2-2.2克
    - 碳水化合物: 总热量 × 45-65%
    - 脂肪: 总热量 × 20-35%

#### 1.2.2 手动设置营养目标功能
- **功能描述**: 允许用户手动设置每日营养目标
- **可设置参数**:
  - 总热量（千卡）
  - 蛋白质（克）
  - 碳水化合物（克）
  - 脂肪（克）
  - 膳食纤维（克）
  - 水分摄入量（毫升）
  - 维生素目标（可选）
  - 矿物质目标（可选）
- **业务逻辑**:
  - 验证用户身份
  - 验证输入参数的合理性
  - 保存用户的营养目标
  - 返回保存后的目标信息

### 1.3 营养记录模块

#### 1.3.1 餐次记录功能
- **功能描述**: 允许用户创建不同餐次的记录
- **餐次类型**:
  - 早餐
  - 午餐
  - 晚餐
  - 加餐
- **业务逻辑**:
  - 验证用户身份
  - 创建餐次记录
  - 返回餐次记录ID

#### 1.3.2 食物记录功能
- **功能描述**: 允许用户记录每餐摄入的食物及其营养成分
- **输入信息**:
  - 食物名称/ID
  - 份量
  - 单位
- **业务逻辑**:
  - 验证用户身份
  - 查找食物的营养成分数据
  - 根据份量计算实际摄入的营养成分
  - 创建食物记录
  - 返回食物记录信息

#### 1.3.3 食物搜索与选择功能
- **功能描述**: 允许用户搜索和选择食物
- **搜索方式**:
  - 按食物名称搜索
  - 按食物类别筛选
  - 最近使用的食物
- **业务逻辑**:
  - 验证用户身份
  - 根据搜索条件查询食物库
  - 返回匹配的食物列表

### 1.4 数据分析与可视化模块

#### 1.4.1 每日营养摄入统计功能
- **功能描述**: 实时展示当日已摄入与目标的对比
- **统计内容**:
  - 总热量
  - 蛋白质
  - 碳水化合物
  - 脂肪
  - 膳食纤维
  - 水分摄入量
- **展示方式**:
  - 数字对比（已摄入/目标）
  - 百分比进度条
- **业务逻辑**:
  - 验证用户身份
  - 获取用户当日的营养记录
  - 计算总摄入量
  - 获取用户的营养目标
  - 计算完成百分比
  - 返回统计结果

#### 1.4.2 历史记录查询功能
- **功能描述**: 允许用户按日期、周、月查看历史营养记录
- **查询条件**:
  - 开始日期
  - 结束日期
  - 餐次类型（可选）
  - 食物类型（可选）
- **业务逻辑**:
  - 验证用户身份
  - 根据查询条件筛选记录
  - 返回历史记录列表

#### 1.4.3 营养趋势分析功能
- **功能描述**: 生成营养摄入趋势图表
- **分析维度**:
  - 按日/周/月的热量摄入趋势
  - 宏量营养素比例趋势
  - 各类食物摄入比例趋势
- **业务逻辑**:
  - 验证用户身份
  - 获取指定时间段的营养记录
  - 按分析维度进行数据聚合
  - 生成趋势数据
  - 返回趋势分析结果

### 1.5 食物库管理模块

#### 1.5.1 内置食物库功能
- **功能描述**: 提供常见食物的营养成分数据
- **食物分类**:
  - 谷物类
  - 肉类
  - 蔬菜类
  - 水果类
  - 乳制品类
  - 油脂类
  - 坚果类
  - 饮料类
  - 其他类
- **数据来源**:
  - 中国食物成分表
  - 美国农业部(USDA)食物数据库

#### 1.5.2 自定义食物管理功能
- **功能描述**: 允许用户添加自定义食物
- **输入信息**:
  - 食物名称
  - 基础份量
  - 单位
  - 营养成分（热量、蛋白质、碳水化合物、脂肪等）
- **业务逻辑**:
  - 验证用户身份
  - 验证输入信息的合法性
  - 创建自定义食物记录
  - 返回自定义食物信息

## 2. API接口详细说明

### 2.1 认证相关接口

#### 2.1.1 用户注册接口
- **URL**: `POST /api/v1/auth/register`
- **功能**: 用户注册
- **请求体**:
  ```json
  {
    "email": "user@example.com",
    "phone": "13800138000",
    "password": "Password123",
    "confirm_password": "Password123",
    "nickname": "用户昵称"
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "注册成功",
    "data": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "email": "user@example.com",
      "phone": "13800138000",
      "nickname": "用户昵称",
      "created_at": "2023-10-01T12:00:00Z"
    }
  }
  ```

#### 2.1.2 用户登录接口
- **URL**: `POST /api/v1/auth/login`
- **功能**: 用户登录
- **请求体**:
  ```json
  {
    "email": "user@example.com",
    "password": "Password123"
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "登录成功",
    "data": {
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "token_type": "Bearer",
      "expires_in": 86400,
      "user": {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "email": "user@example.com",
        "nickname": "用户昵称",
        "gender": 0,
        "age": null,
        "height": null,
        "weight": null,
        "activity_level": 3
      }
    }
  }
  ```

#### 2.1.3 用户登出接口
- **URL**: `POST /api/v1/auth/logout`
- **功能**: 用户登出
- **认证**: 需要JWT令牌
- **响应**:
  ```json
  {
    "code": 200,
    "message": "登出成功"
  }
  ```

### 2.2 用户信息接口

#### 2.2.1 获取用户信息接口
- **URL**: `GET /api/v1/users/profile`
- **功能**: 获取当前用户信息
- **认证**: 需要JWT令牌
- **响应**:
  ```json
  {
    "code": 200,
    "message": "获取成功",
    "data": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "email": "user@example.com",
      "phone": "13800138000",
      "nickname": "用户昵称",
      "gender": 1,
      "age": 25,
      "height": 175,
      "weight": 70,
      "activity_level": 3,
      "created_at": "2023-10-01T12:00:00Z"
    }
  }
  ```

#### 2.2.2 更新用户信息接口
- **URL**: `PUT /api/v1/users/profile`
- **功能**: 更新当前用户信息
- **认证**: 需要JWT令牌
- **请求体**:
  ```json
  {
    "nickname": "新昵称",
    "gender": 1,
    "age": 26,
    "height": 175,
    "weight": 68,
    "activity_level": 4
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "更新成功",
    "data": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "email": "user@example.com",
      "nickname": "新昵称",
      "gender": 1,
      "age": 26,
      "height": 175,
      "weight": 68,
      "activity_level": 4,
      "updated_at": "2023-10-02T12:00:00Z"
    }
  }
  ```

### 2.3 营养目标接口

#### 2.3.1 获取营养目标接口
- **URL**: `GET /api/v1/goals`
- **功能**: 获取当前用户的营养目标
- **认证**: 需要JWT令牌
- **响应**:
  ```json
  {
    "code": 200,
    "message": "获取成功",
    "data": {
      "id": "550e8400-e29b-41d4-a716-446655440001",
      "user_id": "550e8400-e29b-41d4-a716-446655440000",
      "calories": 2000,
      "protein": 70,
      "carbohydrates": 250,
      "fat": 67,
      "fiber": 25,
      "water": 2000,
      "vitamin_a": 800,
      "vitamin_c": 90,
      "vitamin_d": 15,
      "calcium": 1000,
      "iron": 8,
      "created_at": "2023-10-01T12:00:00Z",
      "updated_at": "2023-10-01T12:00:00Z"
    }
  }
  ```

#### 2.3.2 设置营养目标接口
- **URL**: `POST /api/v1/goals`
- **功能**: 设置或更新用户的营养目标
- **认证**: 需要JWT令牌
- **请求体**:
  ```json
  {
    "calories": 1800,
    "protein": 80,
    "carbohydrates": 200,
    "fat": 55,
    "fiber": 30,
    "water": 2500,
    "vitamin_a": 800,
    "vitamin_c": 90,
    "vitamin_d": 15,
    "calcium": 1000,
    "iron": 8
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "设置成功",
    "data": {
      "id": "550e8400-e29b-41d4-a716-446655440001",
      "user_id": "550e8400-e29b-41d4-a716-446655440000",
      "calories": 1800,
      "protein": 80,
      "carbohydrates": 200,
      "fat": 55,
      "fiber": 30,
      "water": 2500,
      "vitamin_a": 800,
      "vitamin_c": 90,
      "vitamin_d": 15,
      "calcium": 1000,
      "iron": 8,
      "updated_at": "2023-10-02T12:00:00Z"
    }
  }
  ```

#### 2.3.3 自动计算营养目标接口
- **URL**: `POST /api/v1/goals/calculate`
- **功能**: 根据用户信息自动计算营养目标
- **认证**: 需要JWT令牌
- **请求体**:
  ```json
  {
    "gender": 1,
    "age": 25,
    "height": 175,
    "weight": 70,
    "activity_level": 3,
    "goal_type": "maintain" // maintain, lose, gain
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "计算成功",
    "data": {
      "calories": 2000,
      "protein": 70,
      "carbohydrates": 250,
      "fat": 67,
      "fiber": 25,
      "water": 2000
    }
  }
  ```

### 2.4 营养记录接口

#### 2.4.1 获取当日营养记录接口
- **URL**: `GET /api/v1/records/today`
- **功能**: 获取当前用户当日的营养记录
- **认证**: 需要JWT令牌
- **响应**:
  ```json
  {
    "code": 200,
    "message": "获取成功",
    "data": {
      "date": "2023-10-01",
      "total_intake": {
        "calories": 1200,
        "protein": 45,
        "carbohydrates": 150,
        "fat": 35,
        "fiber": 15,
        "water": 1000
      },
      "meal_records": [
        {
          "id": "550e8400-e29b-41d4-a716-446655440002",
          "meal_type": 1,
          "record_date": "2023-10-01T00:00:00Z",
          "record_time": "2023-10-01T08:00:00Z",
          "foods": [
            {
              "id": "550e8400-e29b-41d4-a716-446655440003",
              "food_id": "550e8400-e29b-41d4-a716-446655440004",
              "quantity": 100,
              "unit": "克",
              "name": "鸡蛋",
              "calories": 143,
              "protein": 12.6,
              "carbohydrates": 0.7,
              "fat": 9.5
            }
          ]
        }
      ]
    }
  }
  ```

#### 2.4.2 创建餐次记录接口
- **URL**: `POST /api/v1/records/meal`
- **功能**: 创建新的餐次记录
- **认证**: 需要JWT令牌
- **请求体**:
  ```json
  {
    "meal_type": 1, // 1:早餐, 2:午餐, 3:晚餐, 4:加餐
    "record_time": "2023-10-01T08:00:00Z"
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "创建成功",
    "data": {
      "id": "550e8400-e29b-41d4-a716-446655440002",
      "meal_type": 1,
      "record_date": "2023-10-01T00:00:00Z",
      "record_time": "2023-10-01T08:00:00Z"
    }
  }
  ```

#### 2.4.3 添加食物记录接口
- **URL**: `POST /api/v1/records/food`
- **功能**: 在餐次中添加食物记录
- **认证**: 需要JWT令牌
- **请求体**:
  ```json
  {
    "meal_record_id": "550e8400-e29b-41d4-a716-446655440002",
    "food_id": "550e8400-e29b-41d4-a716-446655440004",
    "quantity": 100,
    "unit": "克"
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "添加成功",
    "data": {
      "id": "550e8400-e29b-41d4-a716-446655440003",
      "meal_record_id": "550e8400-e29b-41d4-a716-446655440002",
      "food_id": "550e8400-e29b-41d4-a716-446655440004",
      "quantity": 100,
      "unit": "克",
      "calories": 143,
      "protein": 12.6,
      "carbohydrates": 0.7,
      "fat": 9.5,
      "fiber": 0,
      "created_at": "2023-10-01T08:00:00Z"
    }
  }
  ```

#### 2.4.4 更新食物记录接口
- **URL**: `PUT /api/v1/records/food/{id}`
- **功能**: 更新食物记录
- **认证**: 需要JWT令牌
- **路径参数**:
  - `id`: 食物记录ID
- **请求体**:
  ```json
  {
    "quantity": 150,
    "unit": "克"
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "更新成功",
    "data": {
      "id": "550e8400-e29b-41d4-a716-446655440003",
      "meal_record_id": "550e8400-e29b-41d4-a716-446655440002",
      "food_id": "550e8400-e29b-41d4-a716-446655440004",
      "quantity": 150,
      "unit": "克",
      "calories": 214.5,
      "protein": 18.9,
      "carbohydrates": 1.05,
      "fat": 14.25,
      "fiber": 0,
      "updated_at": "2023-10-01T08:30:00Z"
    }
  }
  ```

#### 2.4.5 删除食物记录接口
- **URL**: `DELETE /api/v1/records/food/{id}`
- **功能**: 删除食物记录
- **认证**: 需要JWT令牌
- **路径参数**:
  - `id`: 食物记录ID
- **响应**:
  ```json
  {
    "code": 200,
    "message": "删除成功"
  }
  ```

### 2.5 食物库接口

#### 2.5.1 搜索食物接口
- **URL**: `GET /api/v1/foods`
- **功能**: 搜索食物
- **认证**: 需要JWT令牌
- **查询参数**:
  - `keyword`: 搜索关键词
  - `category`: 食物类别（可选）
  - `page`: 页码（默认1）
  - `limit`: 每页数量（默认10）
- **响应**:
  ```json
  {
    "code": 200,
    "message": "搜索成功",
    "data": {
      "total": 100,
      "page": 1,
      "limit": 10,
      "foods": [
        {
          "id": "550e8400-e29b-41d4-a716-446655440004",
          "name": "鸡蛋",
          "category": 2,
          "base_quantity": 100,
          "base_unit": "克",
          "calories": 143,
          "protein": 12.6,
          "carbohydrates": 0.7,
          "fat": 9.5,
          "fiber": 0
        }
      ]
    }
  }
  ```

#### 2.5.2 获取食物详情接口
- **URL**: `GET /api/v1/foods/{id}`
- **功能**: 获取食物详细信息
- **认证**: 需要JWT令牌
- **路径参数**:
  - `id`: 食物ID
- **响应**:
  ```json
  {
    "code": 200,
    "message": "获取成功",
    "data": {
      "id": "550e8400-e29b-41d4-a716-446655440004",
      "name": "鸡蛋",
      "category": 2,
      "base_quantity": 100,
      "base_unit": "克",
      "calories": 143,
      "protein": 12.6,
      "carbohydrates": 0.7,
      "fat": 9.5,
      "fiber": 0,
      "saturated_fat": 3.1,
      "trans_fat": 0,
      "cholesterol": 373,
      "sodium": 124,
      "sugar": 0.7,
      "vitamin_a": 160,
      "vitamin_c": 0,
      "vitamin_d": 41,
      "calcium": 56,
      "iron": 1.8
    }
  }
  ```

#### 2.5.3 创建自定义食物接口
- **URL**: `POST /api/v1/custom-foods`
- **功能**: 创建自定义食物
- **认证**: 需要JWT令牌
- **请求体**:
  ```json
  {
    "name": "自制三明治",
    "base_quantity": 1,
    "base_unit": "份",
    "calories": 350,
    "protein": 20,
    "carbohydrates": 40,
    "fat": 12
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "创建成功",
    "data": {
      "id": "550e8400-e29b-41d4-a716-446655440005",
      "user_id": "550e8400-e29b-41d4-a716-446655440000",
      "name": "自制三明治",
      "base_quantity": 1,
      "base_unit": "份",
      "calories": 350,
      "protein": 20,
      "carbohydrates": 40,
      "fat": 12,
      "created_at": "2023-10-01T08:00:00Z"
    }
  }
  ```

#### 2.5.4 获取自定义食物列表接口
- **URL**: `GET /api/v1/custom-foods`
- **功能**: 获取用户的自定义食物列表
- **认证**: 需要JWT令牌
- **查询参数**:
  - `page`: 页码（默认1）
  - `limit`: 每页数量（默认10）
- **响应**:
  ```json
  {
    "code": 200,
    "message": "获取成功",
    "data": {
      "total": 5,
      "page": 1,
      "limit": 10,
      "custom_foods": [
        {
          "id": "550e8400-e29b-41d4-a716-446655440005",
          "name": "自制三明治",
          "base_quantity": 1,
          "base_unit": "份",
          "calories": 350,
          "protein": 20,
          "carbohydrates": 40,
          "fat": 12
        }
      ]
    }
  }
  ```

## 3. 错误响应格式

### 3.1 通用错误响应
```json
{
  "code": 错误码,
  "message": "错误信息",
  "errors": [
    {
      "field": "字段名",
      "message": "字段错误信息"
    }
  ]
}
```

### 3.2 常见错误码
- **400 Bad Request**: 请求参数错误
- **401 Unauthorized**: 未认证或认证失败
- **403 Forbidden**: 禁止访问
- **404 Not Found**: 请求资源不存在
- **409 Conflict**: 资源冲突（如邮箱已被注册）
- **500 Internal Server Error**: 服务器内部错误

## 4. 数据格式规范

### 4.1 日期时间格式
- 使用ISO 8601格式：`YYYY-MM-DDTHH:mm:ssZ`
- 例如：`2023-10-01T12:00:00Z`

### 4.2 数值格式
- 所有数值使用浮点数表示
- 保留两位小数（如果需要）

### 4.3 枚举类型
- 食物类别：
  - 1: 谷物
  - 2: 肉类
  - 3: 蔬菜
  - 4: 水果
  - 5: 乳制品
  - 6: 油脂
  - 7: 坚果
  - 8: 饮料
  - 9: 其他

- 餐次类型：
  - 1: 早餐
  - 2: 午餐
  - 3: 晚餐
  - 4: 加餐

- 性别：
  - 0: 未知
  - 1: 男
  - 2: 女

- 活动水平：
  - 1: 久坐不动
  - 2: 轻度活动（每周1-3天运动）
  - 3: 中度活动（每周3-5天运动）
  - 4: 重度活动（每周6-7天运动）
  - 5: 极重度活动（体力劳动者或运动员）

## 5. 业务规则与限制

### 5.1 数据验证规则
- 所有API接口必须验证输入参数的合法性
- 敏感数据（如密码）必须进行加密处理
- 唯一性字段（如邮箱、手机号）必须进行唯一性检查

### 5.2 性能与安全要求
- 所有API接口响应时间不超过2秒
- 实现基于Golang Channel的请求频率限制（每IP每分钟最多60次请求）
- 使用SQLite3本地数据库，简化部署
- 使用并发处理提高API响应速度
- 定期备份数据库

### 5.3 Golang特色功能在API中的应用

#### 5.3.1 异步处理食物记录
所有食物记录API都采用异步处理方式，使用Goroutine和Channel实现非阻塞操作，提高系统响应速度。

#### 5.3.2 并发营养数据分析
每日营养总结API使用并发计算方式，为每个餐次分配独立的Goroutine进行营养成分计算，大幅提高处理效率。

#### 5.3.3 基于Channel的请求限流
API层实现了基于令牌桶算法的请求限流中间件，使用Goroutine和Channel实现高效的流量控制。

#### 5.3.4 内存缓存系统
实现了基于sync.Map的并发安全内存缓存，用于存储热点数据如食物库信息，减少数据库访问压力。

#### 5.3.5 Context超时控制
所有API接口都设置了超时控制，防止长时间运行的请求占用系统资源，提高系统稳定性。

### 5.3 用户隐私保护
- 严格保护用户的个人信息和饮食记录
- 只在必要时收集和存储用户数据
- 允许用户删除自己的数据